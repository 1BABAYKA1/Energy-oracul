{% extends "base.html" %}

{% block content %}
	<section id="home" class="layers">
		<div class="layers__container">
			<div class="layers__item layer-1" style="background-image: url(static/back.jpg);"></div>
			<div class="layers__item layer-3">
				<div class="hero-content">
					<h1>Energy Oracle <span>Россети</span></h1>
					<div class="hero-content__p">Forecast of electric energy consumption</div>
				</div>
			</div>
			<div class="layers__item layer-4">
				<canvas class="rain"></canvas>
			</div>
		</div>
	</section>
	<section id="menu" class="layers">
		<div class="layers__container_not_preserve">

			<div class="layers__item layer-1"></div>
			<div class="layers__item layer-3">
				<div class="hero-content">
					<section id="header-container">
						<div class="dropdown">
							<label for="layer-select">Тип геолокации</label>
							<select id="layer-select">
								<option value="sam">Написать самому</option>
								<option value="nesam">Текущая геопозиция</option>
							</select>
						</div>
						<div id="input-container" style="display: none;">
							<label for="custom-location">Введите геолокацию:</label>
							<input type="text" id="custom-location" />
						</div>
					
						<div class="dropdown">
							<label for="layer-select-2">Время прогноза</label>
							<select id="layer-select-2">
								<option value="1">1 час</option>
								<option value="6">6 часов</option>
								<option value="24">1 сутки</option>
								<option value="72">3 суток</option>
								<option value="168">1 неделя</option>

							</select>
						</div>
						<div class="file-upload">
							<input type="file" id="file-input" accept=".excel, .csv" style="display: none;" />
							<button id="upload-button">Загрузить файл</button>
						</div>
					<button class="button-start" id='predict-button'>
						<a class="text">Попробовать предсказание</a>
					</button>
				</div>
			</div>
			<div class="layers__item layer-4">
				<canvas class="rain"></canvas>
			</div>
		</div>
	</section>
<script>
	const button = document.getElementById('predict-button');
	const uploadLabel = document.getElementById('upload-button');
	const fileInput = document.getElementById('file-input');
	const layerInput = document.getElementById('layer-select');
	const layer2Input = document.getElementById('layer-select-2');
	
	let selectedFile;
	let formData;
	let tokenKey; // Специальный токен-ключ
	let latitude;
	let longitude;
	fileInput.addEventListener('change', function() {
		selectedFile = this.files[0];
		if (selectedFile) {
			formData = new FormData();
			
			// Генерируем токен-ключ
			tokenKey = generateTokenKey(); // Ваша функция для генерации токен-ключа
			
			// Переименовываем файл и добавляем его в FormData
			const renamedFile = new File([selectedFile], tokenKey + '.' + selectedFile.name.split('.').pop());
			formData.append('file', renamedFile);
	
			uploadLabel.classList.add('uploaded');
			uploadLabel.textContent = 'Файл загружен';
	
			uploadLabel.removeEventListener('click', openFileInput);
		}
	});
	
	button.addEventListener('click', function() {
		if (selectedFile && tokenKey) {
			const params = new URLSearchParams();
			params.append('val', layerInput.value);
			params.append('val', layer2Input.value);
			if ("geolocation" in navigator) {
				params.append('val1', latitude);
				params.append('val2', longitude);
			}
	
			// Добавляем токен-ключ к параметрам
			params.append('tokenKey', tokenKey);
	
			fetch('/upload?' + params.toString(), {
				method: 'POST',
				body: formData
			})
			.then(response => response.text())
			.then(data => {
				console.log('Ответ сервера:', data);
			})
			.catch(error => {
				console.error('Ошибка загрузки файла:', error);
			});
		}
	});
	
	function openFileInput() {
		fileInput.click();
	}
	
	uploadLabel.addEventListener('click', openFileInput);
	
	if ("geolocation" in navigator) {
		layerInput.addEventListener('change', function() {
			if (this.value === 'nesam') {
				navigator.geolocation.getCurrentPosition(function(position) {
					latitude = position.coords.latitude;
					longitude = position.coords.longitude;
				});
			}
		});
	}

function generateTokenKey(length = 20) {
    const characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let token = '';
    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        token += characters[randomIndex];
    }
    return token;
}


</script>
{% endblock %}
